<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Spotify Callback</title>

  <script>
    async function base64urlencode(str) {
      return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");
    }

    async function generateCodeVerifier() {
      const array = new Uint8Array(64);
      crypto.getRandomValues(array);
      return base64urlencode(array);
    }

    async function generateCodeChallenge(verifier) {
      const data = new TextEncoder().encode(verifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return base64urlencode(digest);
    }

    async function exchangeCodeForToken(code, verifier) {
      const body = new URLSearchParams({
        grant_type: "authorization_code",
        code,
        redirect_uri: "https://soundmind.vercel.app/callback.html",
        client_id: "bb0e0bc9ddff42b782eca5a6957f22f6",
        code_verifier: verifier
      });

      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      if (!res.ok) {
        const errText = await res.text();
        console.error("Erro ao trocar código:", errText);
        alert("Erro ao autenticar com Spotify.");
        return null;
      }

      return await res.json();
    }

    async function main() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");

      if (!code) {
        alert("Nenhum código presente na URL.");
        return;
      }

      const verifier = localStorage.getItem("spotify_code_verifier");
      if (!verifier) {
        alert("Code verifier perdido.");
        return;
      }

      const data = await exchangeCodeForToken(code, verifier);
      if (!data) return;

      localStorage.setItem("spotify_token", data.access_token);
      localStorage.setItem("spotify_refresh", data.refresh_token);
      localStorage.setItem("spotify_expires", Date.now() + data.expires_in * 1000);

      // limpar o verifier
      localStorage.removeItem("spotify_code_verifier");

      // enviar de volta para o app
      window.location.href = "https://soundmind.vercel.app/?login=spotify_ok";
    }

    main();
  </script>
</head>
<body>
  Processando login do Spotify...
</body>
</html>
